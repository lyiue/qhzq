<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <link rel="stylesheet" href="css/CRindex.css" media="all">
    <title>道路健康评价管理系统</title>
    <style>
        .layui-nav-tree{vertical-align: top;}
        .cr-content{
            height:63px;
            background-color: #e2e2e2;
        }
        .form-header{
            padding-top: 10px;
            display: inline-block;
        }
        body, html,.editinfo-content{width: 100%;height: 100%;margin:0;font-family:"微软雅黑";
            background-color: #404866
        ;position: relative;}
        .layui-table{
            background-color: inherit;
        }
        .layui-table tbody tr:hover{background-color:#404866!important}
        .layui-table-view .layui-table tbody tr:hover{background-color:#F2F2F2!important}
        .imgButton{
            display: block;
            position: absolute;
            left: 88%;
            top:10px;
        }
        .imgButton img{
            float: left;
            cursor:pointer;
            margin-left: 20px;
        }
        .userExit{
        }
        .editInfo{
            margin: 20px auto;
            color: white;
        }
        .editInfo legend{
            font-size: 20px;
        }
        .editInfo-title p,.accreditInfo-title p{
            text-align: center;
            font-size: 18px;
            margin-top: 15px;
        }
        .accreditInfo-form{
            width:98%;
            height:200px;
            margin:30px auto 10px auto;
            color: white;
        }
        .accredit-table thead tr{
            background-color: #353c66;
        }
        .accredit-table th,.accredit-table td{
            text-align: center;
            border:1px solid #353c66;
        }
        .accredit-table td{
            color: white;
        }
        .accredit-table tbody tr td a:hover {
            color:#ff5140;
        }
        .accredit-table tbody tr td a{
            color:white;
            text-decoration: underline;
            cursor: pointer;
        }
        .accredit p{
            text-align: right;
        }
        .layui-table-view{
            width:350px;
        }
    </style>
</head>

<body>
<div class="layui-fluid">
    <div class="row">
        <div class="layui-side layui-bg-black">
            <div class="layui-side-scroll">
                <ul class="layui-nav layui-nav-tree">
                    <li class="layui-nav-item layui-nav-item-first layui-nav-itemed layui-this">
                        <a class="userSet" href="#">
                            <img src="image/用户.png" style="display: inline-block">
                            <img src="image/用户_12.png" class="MunePich" style="display: none">
                            <p></p>
                        </a>
                    </li>
                    <li class="layui-nav-item layui-nav-itemed ">
                        <a href="index.html">
                            <img src="image/gis.png" style="display: inline-block">
                            <img src="image/gis_h.png" class="MunePich" style="display: none">
                            <p>GIS路况</p>
                        </a>
                    </li>
                    <li class="layui-nav-item layui-nav-itemed ">
                        <a href="#">
                            <img src="image/基础.png" style="display: inline-block">
                            <img src="image/基础_h.png" class="MunePich" style="display: none">
                            <p>基础数据</p>
                        </a>
                        <dl class="layui-nav-child">
                            <dd class=""><a href="CR.baseInfo.html">静态数据</a></dd>
                            <dd><a href="Roadsituation.html">道路现状</a></dd>
                            <dd><a href="Roadrecords.html">健康档案</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item layui-nav-itemed">
                        <a href="#">
                            <img src="image/基础.png" style="display: inline-block">
                            <img src="image/基础_h.png" class="MunePich" style="display: none">
                            <p>技术评定</p>
                        </a>
                        <dl class="layui-nav-child">
                            <dd><a href="RoadtestReport.html">检测报告</a></dd>
                            <dd><a href="Roadassess.html">评定分析</a></dd>
                            <dd><a href="sequential.html">环比分析</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item layui-nav-itemed">
                        <a href="#">
                            <img src="image/病害.png" style="display: inline-block">
                            <img src="image/病害_h.png" class="MunePich" style="display: none">
                            <p>病害诊断</p>
                        </a>
                        <dl class="layui-nav-child">
                            <dd><a href="Roaddisease.html">病害统计</a></dd>
                            <dd><a href="Roaddiseases.it.html">病害成因分析</a></dd>
                            <dd><a href="">3D展示</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item layui-nav-itemed">
                        <a href="RoadPipeline.html">
                            <img src="image/管线.png" style="display: inline-block">
                            <img src="image/管线_h.png" class="MunePich" style="display: none">
                            <p>管线档案</p>
                        </a>
                    </li>
                    <li class="layui-nav-item layui-nav-itemed">
                        <a href="RoadInfo.html">
                            <img src="image/路网.png" style="display: inline-block">
                            <img src="image/路网_h.png" class="MunePich" style="display: none">
                            <p>路网档案</p>
                        </a>
                    </li>
                    <li class="layui-nav-item layui-nav-itemed">
                        <a href="#">
                            <img src="image/养护.png" style="display: inline-block">
                            <img src="image/路网_h.png" class="MunePich" style="display: none">
                            <p>养护科学决策</p>
                        </a>
                        <dl class="layui-nav-child">
                            <dd><a href="RoadDecisiontree.html">决策树</a></dd>
                            <dd><a href="Maintenanceadvice.html">养护建议</a></dd>
                            <dd><a href="Maintenanceevaluation.html">养护报告</a></dd>
                            <dd><a></a></dd>
                        </dl>
                    </li>
                </ul>
            </div>
        </div>
        <div class="cr-content">
            <div class="imgButton">
                <img src="image/切换.png" class="userTypeBut1" style="display: none">
                <img src="image/设置.png" class="userTypeBut2" style="display: none">
                <img src="image/退出.png" class="userExit">
            </div>
        </div>
        <!--个人信息设置-->
        <div class="editinfo-content">
            <div class="edit-info">
                <fieldset class="layui-elem-field layui-field-title editInfo">
                    <legend>个人设置</legend>
                </fieldset>
                <div class="accreditInfo-form">
                <div class="accreditInfo-title">
                <p>授权设置</p>
                </div>
                <table class="layui-table accredit-table">
                <thead>
                <tr>
                    <th>授权道路</th>
                    <th>用户名称</th>
                    <th>单位名称</th>
                    <th>单位地址</th>
                    <th>单位电话</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td colspan="6"><a  class="addAccredit">添加授权</a></td>
                </tr>
                </tbody>
                </table>
                </div>
            </div>
        </div>
    </div>
</div>
<form class="layui-form" action="" style="display: none" id="addAccreditInfo">
    <div class="layui-form-item" style="margin-top: 10px;">
        <div class="layui-inline">
            <label class="layui-form-label">授权用户：</label>
            <div class="layui-input-block">
                <input type="text" name="UserName" lay-filter="required" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">授权道路：</label>
            <div class="layui-input-block">
                <table class="layui-hide" id="test" lay-filter="test"></table>
            </div>
        </div>
    </div>
</form>
<script src="js/jquery-1.9.1.min.js"></script>
<script src="layui/layui.js" charset="utf-8"></script>
<script src="js/IP.js"></script>
<script src="js/index.js"></script>
<script src="js/jquery.serializejson.js"></script>
<script>
    layui.use(['element','form','table','layer'], function(){
        var element = layui.element;
        var form = layui.form;
        var table = layui.table;
        var $ = layui.jquery, layer = layui.layer;



        /*功能条*/
        localStorage.getItem("UserType");
        if(localStorage.getItem("UserType") == 0){
            /*普通用户*/
            $('.userTypeBut2').css('display','block');
        }
        if(localStorage.getItem("UserType") == 1){
            /*工作用户*/
            $('.userTypeBut1').css('display','block');
            $('.userSet').unwrap().wrap('<div class="layui-nav-item layui-nav-item-first layui-nav-itemed"><a class="userSet">'+
                '<img src="image/用户.png" style="display: inline-block">'+
                '<img src="image/用户_12.png" class="MunePich" style="display: none">'+
                '<p></p>'+ '</a></div>')
        }
        /*导航条*/
        var UserName = localStorage.getItem('UserName');
        var UserUnitName = localStorage.getItem('UserUnitName');
        $('.layui-nav-item-first p').html(UserName+':'+UserUnitName);

        $('.userExit').on('click',function () {
            localStorage.removeItem('UserName');
            localStorage.removeItem('UserType');
            localStorage.removeItem('_id');
            localStorage.removeItem('selectId');
            localStorage.removeItem('superId');
            location.href='login.html';
        });
        $('.userTypeBut1').on('click',function () {
            localStorage.setItem('selectId','');
            location.href='superperson.html';
        });
        $('.userTypeBut2').on('click',function () {
            location.href='editinfo.html';
        });

        GetAuthority();
        /*
        * 获取授权
        * */
        function GetAuthority() {
            $.ajax({
                type:'get',
                url:'http://'+ip+'/api/User/GetAuthority',
                data:{
                    UserID:localStorage.getItem("_id")
                },
                success:function (data) {
                    console.log(data);
                    $('.tr1').empty();
                    var tr = '';
                    for(var i = 0;i<data.message.length;i++){
                        tr += '<tr class="tr1">'+
                            '<td style="display: none">'+data.message[i]._id+'</td>'+
                            '<td>'+data.message[i].RoadInfo.BI_RoadName+'</td>'+
                            '<td>'+data.message[i].UserInfo.UserName+'</td>'+
                            '<td>'+data.message[i].UserInfo.UserUnitName+'</td>'+
                            '<td>'+data.message[i].UserInfo.UserUnitAddr+'</td>'+
                            '<td>'+data.message[i].UserInfo.UserPhoneNum+'</td>'+
                            '<td><a  class="deleteAccredit">解除授权</a></td>'+
                            '</tr>'
                    }
                    $('.accredit-table tbody').prepend(tr);
                    deleteAccredit();
                }

            });
        }

        /*
        * 获取用户下所有道路
        * */
        table.render({
            elem: '#test'
            ,method: 'get'
            ,url:'http://'+ip+'/api/User/getRoadlist'
            ,where: {
                UserID:localStorage.getItem("_id")
            }
            ,cols: [[
                {type:'checkbox'}
                ,{field:'_id',title: 'ID', width:100,sort: true,align: 'center'}
                ,{field:'BI_RoadName', width:198,title: '道路名称'}
            ]]
            ,page: false
            ,done: function(res, curr, count){
                console.log(res);
                Res(res);
            }
        });

        function Res(res) {
            var checkedOne = [];
            table.on('checkbox(test)', function(obj){
                if(obj.checked == true && obj.type == 'all'){
                    for(var i = 0;i<res.data.length;i++){
                        checkedOne.push(res.data[i]._id);
                    }
                }
                if(obj.checked == false && obj.type == 'all'){
                    checkedOne = [];
                }
                if(obj.checked == true && obj.type == 'one'){
                    var checkedId = obj.data._id;
                    checkedOne.push(checkedId);
                    function unique(checkedOne){
                        var res =[];
                        for(var i=0,len=checkedOne.length;i<len;i++){
                            var obj = checkedOne[i];
                            if(res.indexOf(obj)===-1) res.push(obj);
                        }
                        return res;
                    }
                    checkedOne = unique(checkedOne);
                }
                Array.prototype.indexOf = function(val) {
                    for(var i = 0; i<this.length;i++){
                        if(this[i] == val){
                            return i;
                        }
                    }
                    return -1;
                };
                Array.prototype.remove = function(val) {
                    var index = this.indexOf(val);
                    if(index>-1){
                        this.splice(index,1);
                    }
                };
                if(obj.checked == false && obj.type == 'one'){
                    var checkedId = obj.data._id;
                    checkedOne.remove(checkedId);
                }
                console.log(checkedOne);
                localStorage.setItem("checkedOne",checkedOne)
            });

        }

        /*
        * 解除授权
        * */
        function deleteAccredit() {
            $('.deleteAccredit').on('click',function () {
                var AuthorityID = $(this).parent().parent().find('td:eq(0)').text();
                layer.open({
                    type:1
                    ,title:"提示消息"
                    ,closeBtn:1
                    ,area: ['380px', '170px']
                    ,shade:0.1
                    ,btn:['确定','取消']
                    ,btnAlign:'c'
                    ,moveType:0.5
                    ,content:"<p style='text-align: center;padding-top: 15px;'>是否确定取消授权？</p>"
                    ,success:function(layero, index){

                    }
                    ,yes:function(index,layero){
                        $.ajax({
                            type:'get',
                            url:'http://'+ip+'/api/User/DelAuthority',
                            data:{
                                AuthorityID:AuthorityID
                            },
                            success:function (data) {
                                console.log(data);
                                if(data.success){
                                    layer.open({
                                        type:1
                                        ,title:"提示消息"
                                        ,closeBtn:1
                                        ,area: ['380px', '170px']
                                        ,shade:0.1
                                        ,btn:'确定'
                                        ,btnAlign:'c'
                                        ,moveType:0.5
                                        ,content:"<p style='text-align: center;padding-top: 15px;'>"+data.message+"</p>"
                                        ,success:function(layero, index){

                                        }
                                        ,yes:function(index,layero){
                                            layer.closeAll();
                                            GetAuthority();
                                        },
                                        btn2:function () {
                                            layer.closeAll();
                                            GetAuthority();
                                        }
                                        ,cancel:function(index,layero){
                                            layer.closeAll();
                                            GetAuthority();
                                        }
                                    });
                                }
                            }
                        })
                    }
                    ,cancel:function(index,layero){
                        layer.closeAll();
                        GetAuthority();
                    }
                });

            })
        }

        /*
        * 清空选中
        * */
        function clearCheck() {
            localStorage.removeItem("checkedOne");
            $('.layui-table-box .layui-form-checkbox').removeClass("layui-form-checked");
        }

        /*
         * 添加授权
         * */
        $('.addAccredit').on('click',function () {
            $('input[name="UserName"]').val('');
            layer.open({
                type: 1
                ,title:'新增授权'
                ,content: $('#addAccreditInfo')
                ,area: ['500px','400px']
                ,btn: ['确定','取消']
                ,btnAlign: 'c'
                ,shade: 0.8
                ,yes: function(index, layero){
                    $.ajax({
                        type:'post',
                        url:'http://'+ip+'/api/User/AddAuthority',
                        data:{
                            RoadID: localStorage.getItem("checkedOne"),
                            UserID:localStorage.getItem("_id"),
                            UserName:$('input[name="UserName"]').val()
                        },
                        success:function (data) {
                            console.log(data);
                            if(data.success){
                                layer.open({
                                    type:1
                                    ,title:"提示消息"
                                    ,closeBtn:1
                                    ,area: ['380px', '170px']
                                    ,shade:0.1
                                    ,btn:'确定'
                                    ,btnAlign:'c'
                                    ,moveType:0.5
                                    ,content:"<p style='text-align: center;padding-top: 15px;'>"+data.message+"</p>"
                                    ,success:function(layero, index){

                                    }
                                    ,yes:function(index,layero){
                                        layer.closeAll();
                                        GetAuthority();
                                        clearCheck()
                                    }
                                    ,cancel:function(index,layero){
                                        layer.closeAll();
                                        GetAuthority();
                                        clearCheck()
                                    }
                                });
                            }else{
                                layer.open({
                                    type:1
                                    ,title:"提示消息"
                                    ,closeBtn:1
                                    ,area: ['380px', '170px']
                                    ,shade:0.1
                                    ,btn:'确定'
                                    ,btnAlign:'c'
                                    ,moveType:0.5
                                    ,content:"<p style='text-align: center;padding-top: 15px;'>"+data.message+"</p>"
                                    ,success:function(layero, index){

                                    }
                                    ,yes:function(index,layero){
                                        layer.close(index);
                                        clearCheck()
                                    }
                                    ,cancel:function(index,layero){
                                        layer.close(index);
                                        clearCheck()
                                    }
                                });
                            }
                        }
                    })
                }
                ,btn1: function (index, layero) {

                }
                ,btn2: function (index, layero) {
                    layer.closeAll();
                    clearCheck();
                }
            });
        })
    });
</script>
</body>
</html>